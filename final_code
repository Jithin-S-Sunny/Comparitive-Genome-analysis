

# Variant Analysis Pipeline

conda install -c bioconda -y minimap2 samtools bcftools mummer syri snpeff bedtools

conda activate pan_genome

# Step 1: Check Reference and Query Genomes

seqkit fx2tab -n -l pseudo_ref.fna  
seqkit fx2tab -n -l F27_B1.fna      

# Step 2: Read Alignment Using minimap2

minimap2 -ax asm5 pseudo_ref.fna F27_B1.fna | samtools view -Sb -o strain_aligned.bam

# Step 3: Sort and Index BAM File

samtools sort -o strain_sorted.bam strain_aligned.bam
samtools index strain_sorted.bam

# Step 4: Generate Mapping Statistics

samtools flagstat strain_sorted.bam  
samtools depth strain_sorted.bam | awk '{sum+=$3} END {print "Average depth:", sum/NR}'  
samtools idxstats strain_sorted.bam  

# Step 5: Variant Calling with bcftools

bcftools mpileup -Ou -f pseudo_ref.fna strain_sorted.bam | bcftools call -mv -Ov -o raw_variants.vcf

# Step 6: Filter Variants (Remove Low-Quality Calls)

bcftools filter -i 'QUAL>20 && DP>10' raw_variants.vcf -o filtered_variants.vcf

# Step 7: Inspect Variant Calls

bcftools view -H raw_variants.vcf | head -n 10

# Step 8: Structural Variant Analysis with MUMmer

nucmer --maxmatch -c 100 pseudo_ref.fna F27_B1.fna -p genome_comparison
show-snps -Clr genome_comparison.delta > genome_variants.txt

# Step 9: Identify Structural Variations

show-coords -rcl genome_comparison.delta > alignment_summary.txt
grep -E "\s-\s" alignment_summary.txt > inversions.txt  
awk '$3-$4 > 5000' alignment_summary.txt > deletions.txt 
awk '$6 < 95' alignment_summary.txt > low_identity_regions.txt  

# Step 9: Plot alignment
mummer.py

# Step 10: Genome Coverage Analysis

bedtools genomecov -ibam strain_sorted.bam -bga > uncovered_regions.bed


# Step 12: Variant Annotation with SnpEff

java -jar snpEff.jar databases | grep Pseudomonas
java -jar snpEff.jar download Pseudomonas_aeruginosa


java -Xmx4G -jar snpEff.jar Pseudomonas_aeruginosa filtered_variants.vcf > annotated_snpeff.vcf

# Step 13: Generate Annotation Summary

java -jar snpEff.jar -stats snpEff_summary.html annotated_snpeff.vcf

